<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>Joystick playground</title>
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
        <link rel="stylesheet" href="stylesheets/styles.css" media="screen" title="no title" charset="utf-8">
        <link rel="stylesheet" href="stylesheets/github-light.css" media="screen" title="no title" charset="utf-8">
        <style>

        </style>
    </head>
    <body>

        <div id="zone_joystick">
            <div id="debug">
                <ul>
                    <li class="distance">physical distance from the center (px) : <span class='data'></span></li>
                    <li class="angle">
                        angle :
                        <ul>
                            <li class="radian">radian : <span class='data'></span></li>
                            <li class="degree">degree : <span class='data'></span></li>
                        </ul>
                    </li>
                </ul>
            </div>
            <div class="zone dynamic active"></div>
        </div>
        <div class="graphContainer">
            Normalized input:
            <div id="normVis"></div>
            <div>
                normalized X: <span id="normX"></span></br>
                normalized Y: <span id="normY"></span>
            </div>
            <label>
                <input type="checkbox" id="normTrace"/> Show traces
            </label>
            <button id="clearNormalizedView">Clear</button>
        </div>
        <div class="graphContainer">
            Transfer function:
            <div id="velocityVis"></div>
            <div>
                Normalized joystick distance = <span id="vIn"></span><br/>
                Ship movement distance = <span id="vOut"></span><br/>
            </div>
        </div>
        <div class="editorContainer">
            <label>
                Transfer function:
                <select id="tfSel"></select>
                <div id="transferFunctionEditor"></div>
                <button id="updateTransferFunction">Update</button>
            </label>
        </div>

        <div class="outputContainer">
            <!-- The canvas for the panning background -->
            <canvas id="background" width="300" height="300">
                Your browser does not support canvas. Please try again with a different browser.
            </canvas>
            <!-- The canvas for all enemy ships and bullets -->
            <canvas id="main" width="300" height="300">
            </canvas>
            <!-- The canvas the ship uses (can only move up
             one forth the screen.) -->
            <canvas id="ship" width="300" height="300">
            </canvas>
        </div>
        <div class="shipParameterContainer">
            <div>
                ship X: <span id="shipX"></span></br>
                ship Y: <span id="shipY"></span>
            </div>
            <button id="resetShip">Reset ship</button>
        </div>


        <!-- JS libraries -->
        <script src="lib/nipplejs.min.js" charset="utf-8"></script>
        <script src="lib/d3.v3.min.js" charset="utf-8"></script>
        <script src="lib/vega.js" charset="utf-8"></script>
        <script src="lib/vega-lite.js" charset="utf-8"></script>
        <script src="lib/vega-embed.js" charset="utf-8"></script>
        <script src="lib/jquery-3.1.1.min.js" charset="utf-8"></script>
        <script src="lib/space_shooter.js" charset="utf-8"></script>

        <!-- app logic -->
         <script>
            // shared configuration object
            var config = {
                normalizedView: {
                    showTrace: false
                },
                transferFunction: null,
                tfEditor: null,
                ship: {
                    start: null    // populate by shape_shooter.js
                }

            };

            // globals
            var joystick;               // joystick object
            var joystickData = null;    // data from the joystick widget (initialized in joystick-init.js)
            var vis = {};
            vis.norm = null         // vega view object for normalized view (initialized in vis-normalized-init.js)
            vis.velo = null         // vega view object for velocity view (initialized in vis-velocity-init.js)

            var transferFunctions = {
                identity: "return d;",
                constant: "if (Math.abs(d) > 0) {\n\t return Math.sign(d) * 2.5;\n} else {\n\t return 0;\n}",
                stepConstant: "if (Math.abs(d) < 0.5) {\n\t return Math.sign(d) * 2;\n} else {\n\t return Math.sign(d) * 5;\n}",
                linear: "return d * 5;",
                stepLinear: "if (Math.abs(d) < 0.5) {\n\t return d * 2;\n} else {\n\t return d * 5;\n}",
                power: "return Math.sign(d) * Math.pow(4 * d, 2);",
                sigmoid: "return  Math.sign(d) * ( 4.5 / (1 + Math.exp(-((d-0.4) * 20))));"
            };

        </script>

        <script src="js/util.js" charset="utf-8"></script> <!-- defines util module -->
        <script src="js/vis-helper.js" charset="utf-8"></script> <!-- defines visHelper module -->
        <script src="js/joystick-init.js" charset="utf-8"></script> <!-- initializes joystick -->
        <script src="js/vis-normalized-init.js" charset="utf-8"></script>  <!-- initializes vis.norm -->
        <script src="js/vis-velocity-init.js" charset="utf-8"></script>  <!-- initializes vis.velo -->


        <!-- transfer function editor -->
        <script src="lib/ace/src-min-noconflict/ace.js" type="text/javascript" charset="utf-8"></script>
        <script>
          var editor = ace.edit("transferFunctionEditor");
          editor.setTheme("ace/theme/xcode");
          var session = editor.getSession()
          session.setMode("ace/mode/javascript");
          session.setUseWrapMode(true);
          session.setWrapLimitRange(30, 35);
          editor.$blockScrolling = Infinity

          // remember the editor in our namespace
          config.tfEditor = editor;
        </script>

        <!-- code related to event and input processing -->
        <script>
            var samplingRate  = 1000 / 30;
            var queueNextLoop = (function (callback) { window.setTimeout( callback,  samplingRate);});

            var hist = {                    // history
                normInput: {x: 0, y: 0},
                output: {x: 0, y: 0},
                timestamp: Date.now()
            };

            // main event loop
            function eventLoop() {
                // window.requestAnimFrame(eventLoop);
                queueNextLoop(eventLoop);

                // retrieve raw data from joystick
                if (joystickData === null ||
                    joystickData.distance < 0)     // papaya
                {
                    joystickData = {
                        angle: { degree: 0, radian: 0},
                        distance: 0,
                        position: {x: 0,y: 0}
                    }
                }

                // process input signal
                var norm = normalizeInput(joystickData);

                // update normalized input signal vis
                if (config.normalizedView.showTrace)
                    visHelper.addPoint(vis.norm, norm.x, norm.y);
                else
                    visHelper.updatePoint(vis.norm, norm.x, norm.y);

                // apply transfer function
                var tDist = config.transferFunction(norm.dist);
                var scale = tDist / norm.dist;
                if (isNaN(scale))
                    scale = 0;

                var trans = {
                    x: scale * norm.x,
                    y: scale * norm.y,
                    dist: tDist
                };

                // calculate ship position
                var currentShip = {
                    x: game.ship.x,
                    y: game.ship.y
                }
                shipTarget = {
                    x: currentShip.x + trans.x,
                    y: currentShip.y - trans.y,
                }

                // indirect absolute mapping
                // shipTarget = {
                //     x: (trans.x + 1) * 600 / 2,
                //     y: 350 - ((trans.y + 1) * 350 / 2),
                // }

                // move the ship
                game.ship.addEvent({"type": "move", data: shipTarget});


                // update velocity
                var dT = (Date.now() - hist.timestamp) / 1000;
                var velocity = {
                    input: util.pointDist(util.pointZero, norm),
                    output: util.pointDist(util.pointZero, trans)
                };
                visVelocity.updateVelocity(velocity);


                // update text
                $("#normX").text(norm.x.toFixed(2));
                $("#normY").text(norm.y.toFixed(2));
                $("#vIn").text(velocity.input.toFixed(2));
                $("#vOut").text(velocity.output.toFixed(2));

                // record historical data
                hist.normInput = norm;
                hist.output = currentShip;
                hist.timestamp = Date.now();

            };

            function normalizeInput(data) {
                var normDist = data.distance / 50.0;
                var normX = normDist * Math.cos(data.angle.radian);
                var normY = normDist * Math.sin(data.angle.radian);
                return {
                    x: normX,
                    y: normY,
                    angle: data.angle.radian,
                    dist: normDist
                };
            }

            function updateTransferFunction() {
                var funcBody = config.tfEditor.getValue();
                var func = Function("d", funcBody);
                visVelocity.updateTransferFunction(func);
                config.transferFunction = func;
            }

            // initialize UI
            (function () {

                // fill options for transfer functions
                $.each(transferFunctions, function (name, funcBody) {
                    $('#tfSel').append($('<option>', {value: name, text: name}));
                });
                $('#tfSel').change(function (e) {
                    var tfName = this.options[e.target.selectedIndex].text
                    config.tfEditor.setValue(transferFunctions[tfName]);
                });


                // event bindings
                $("#normTrace")
                    .prop("checked", config.normalizedView.showTrace)
                    .click(function() { config.normalizedView.showTrace = this.checked;} );

                $('#clearNormalizedView').click( function(){ visHelper.clearView(vis.norm); });
                $('#updateTransferFunction').click( function() { updateTransferFunction(); });
                $("#resetShip").click( function() {
                    game.ship.addEvent({"type": "move", data: {x: config.ship.start.x, y: config.ship.start.y}});
                });

                // set initial transfer function
                window.setTimeout( function() {
                    config.tfEditor.setValue(transferFunctions.identity);
                    updateTransferFunction();

                    // fire the main event loop
                    $(document).ready(eventLoop);
                }, 100);
            })();



        </script>


    </body>
</html>
