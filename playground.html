<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>Joystick playground</title>
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
        <link rel="stylesheet" href="stylesheets/styles.css" media="screen" title="no title" charset="utf-8">
        <link rel="stylesheet" href="stylesheets/github-light.css" media="screen" title="no title" charset="utf-8">
        <style>

        </style>
    </head>
    <body>

        <div id="zone_joystick">
            <div id="debug">
                <ul>
                    <li class="position">
                        input space position (px) :
                        <ul>
                            <li class="x">x : <span class='data'></span></li>
                            <li class="y">y : <span class='data'></span></li>
                        </ul>
                    </li>
                    <li class="distance">distance (px) : <span class='data'></span></li>
                    <li class="angle">
                        angle :
                        <ul>
                            <li class="radian">radian : <span class='data'></span></li>
                            <li class="degree">degree : <span class='data'></span></li>
                        </ul>
                    </li>
                </ul>
            </div>
            <div class="zone dynamic active"></div>
        </div>
        <div id="normVisContainer">
            Normalized input:
            <div id="normVis"></div>
            <br/>
            <label>
                <input type="checkbox" id="normTrace"/> Show traces
            </label>
            <button id="clearNormalizedView">Clear</button>
            <div>
                normalized X: <span id="normX"></span></br>
                normalized Y: <span id="normY"></span>
            </div>
        </div>

        <div id="spaceshipContainer">
            <!-- The canvas for the panning background -->
            <canvas id="background" width="600" height="360">
                Your browser does not support canvas. Please try again with a different browser.
            </canvas>
            <!-- The canvas for all enemy ships and bullets -->
            <canvas id="main" width="600" height="360">
            </canvas>
            <!-- The canvas the ship uses (can only move up
             one forth the screen.) -->
            <canvas id="ship" width="600" height="360">
            </canvas>
            <div>
                ship X: <span id="shipX"></span></br>
                ship Y: <span id="shipY"></span>
            </div>
        </div>


        <!-- JS libraries -->
        <script src="lib/nipplejs.min.js" charset="utf-8"></script>
        <script src="lib/d3.v3.min.js" charset="utf-8"></script>
        <script src="lib/vega.js" charset="utf-8"></script>
        <script src="lib/vega-lite.js" charset="utf-8"></script>
        <script src="lib/vega-embed.js" charset="utf-8"></script>
        <script src="lib/jquery-3.1.1.min.js" charset="utf-8"></script>
        <script src="lib/space_shooter.js" charset="utf-8"></script>

        <!-- app logic -->
         <script>
            // globals
            var joystick;
            var normalizedView;
            var config = {
                normalizedView: {
                    showTrace: false
                }
            };
            var joystickData = null;
        </script>
        <script src="js/joystick-init.js" charset="utf-8"></script>
        <script>

            function normalizeInput(data) {
                var normX = data.distance / 50 * Math.cos(data.angle.radian);
                var normY = data.distance / 50 * Math.sin(data.angle.radian);
                return {x: normX, y: normY};
            }

            var samplingRate  = 1000 / 60;
            var queueNextLoop = (function (callback) { window.setTimeout( callback,  samplingRate);});

            // main event loop
            function eventLoop() {
                window.requestAnimFrame(eventLoop)

                // retrieve raw data from joystick
                if (joystickData === null ||
                    joystickData.distance < 12)     // papaya
                {
                    joystickData = {
                        angle: {
                            degree: 0,
                            radian: 0
                        },
                        distance: 0,
                        position: {
                            x: 0,
                            y: 0
                        }
                    }
                }

                // process input signal
                norm = normalizeInput(joystickData);

                // update vis
                updateVis(norm);

                // update text
                $("#normX").text(norm.x.toFixed(2));
                $("#normY").text(norm.y.toFixed(2));

                // send event to spaceship
                game.ship.addEvent({"type": "move", data: norm});
            };
            $(document).ready(eventLoop);



            (initUI = function () {
                $("#normTrace")
                    .prop("checked", config.normalizedView.showTrace)
                    .click(function() { config.normalizedView.showTrace = this.checked;} );


            })();


//=======================================

//=======================================

            var updatePoint = function(view, x, y) {
                view.data("source")
                    .update(function(d){return true;}, "x", function(d){return x;})
                    .update(function(d){return true;}, "y", function(d){return y;});
                view.update()
            }

            var addPoint = function(view, x, y) {
                view.data("source").insert([{"x": x, "y": y }])
                view.update()
            }

            // update vis
            function updateVis(norm) {
                if (config.normalizedView.showTrace)
                {
                    addPoint(normalizedView, norm.x, norm.y);
                }
                else
                {
                    updatePoint(normalizedView, norm.x, norm.y);
                }
            }


            $('#clearNormalizedView').click( function(){ clearView(normalizedView); });
            function clearView(view) {
                view.data("source").remove(function(d) { return true; });
                view.update();
            }

            // cursor visualiztion
            vlSpec = {
              "data": { "name": "normalizedInput", "values": [ {"x": 0,"y": 0, "id": "position"} ] },
              "mark": "point",
              "encoding": {
                "x": {
                  "field": "x",
                  "type": "quantitative",
                  "scale": {"domain": [-1, 1], "range": "width", "zero": false},
                  "axis": {"ticks": 10}
                },
                "y": {
                  "field": "y",
                  "type": "quantitative",
                  "scale": {"domain": [-1, 1], "range": "width", "zero": false},
                  "axis": {"ticks": 10}
                }
              }
            }

            var embedSpec = {
              mode: "vega-lite",
              spec: vlSpec,
              actions: false
            }
            vg.embed("#normVis", embedSpec, function(error, result) {
              normalizedView = result.view;
            });
        </script>


    </body>
</html>
