<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>Joystick playground</title>
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
        <link rel="stylesheet" href="stylesheets/styles.css" media="screen" title="no title" charset="utf-8">
        <link rel="stylesheet" href="stylesheets/github-light.css" media="screen" title="no title" charset="utf-8">
        <style>

        </style>
    </head>
    <body>

        <div id="zone_joystick">
            <div id="debug">
                <ul>
                    <li class="position">
                        input space position (px) :
                        <ul>
                            <li class="x">x : <span class='data'></span></li>
                            <li class="y">y : <span class='data'></span></li>
                        </ul>
                    </li>
                    <li class="distance">distance (px) : <span class='data'></span></li>
                    <li class="angle">
                        angle :
                        <ul>
                            <li class="radian">radian : <span class='data'></span></li>
                            <li class="degree">degree : <span class='data'></span></li>
                        </ul>
                    </li>
                </ul>
            </div>
            <div class="zone dynamic active"></div>
        </div>
        <div class="graphContainer">
            Normalized input:
            <div id="normVis"></div>
            <div>
                normalized X: <span id="normX"></span></br>
                normalized Y: <span id="normY"></span>
            </div>
            <label>
                <input type="checkbox" id="normTrace"/> Show traces
            </label>
            <button id="clearNormalizedView">Clear</button>
        </div>
        <div class="graphContainer">
            Velocity:
            <div id="velocityVis"></div>
            <div>
                Input velocity, x = <span id="vIn"></span><br/>
                <label>
                    Transfer function =
                    <input id="transferFunctionIn" type="text" value="x"/>
                    <button id="updateTransferFunction">Update</button>
                </label><br/>
                Output velocity, T(x) = <span id="vOut"></span>
            </div>
        </div>

        <div id="spaceshipContainer">
            <!-- The canvas for the panning background -->
            <canvas id="background" width="600" height="360">
                Your browser does not support canvas. Please try again with a different browser.
            </canvas>
            <!-- The canvas for all enemy ships and bullets -->
            <canvas id="main" width="600" height="360">
            </canvas>
            <!-- The canvas the ship uses (can only move up
             one forth the screen.) -->
            <canvas id="ship" width="600" height="360">
            </canvas>
            <div>
                ship X: <span id="shipX"></span></br>
                ship Y: <span id="shipY"></span>
            </div>
        </div>


        <!-- JS libraries -->
        <script src="lib/nipplejs.min.js" charset="utf-8"></script>
        <script src="lib/d3.v3.min.js" charset="utf-8"></script>
        <script src="lib/vega.js" charset="utf-8"></script>
        <script src="lib/vega-lite.js" charset="utf-8"></script>
        <script src="lib/vega-embed.js" charset="utf-8"></script>
        <script src="lib/jquery-3.1.1.min.js" charset="utf-8"></script>
        <script src="lib/space_shooter.js" charset="utf-8"></script>

        <!-- app logic -->
         <script>
            // shared configuration object
            var config = {
                normalizedView: {
                    showTrace: false
                },
                transferFunction: null
            };

            // globals
            var joystick;               // joystick object
            var joystickData = null;    // data from the joystick widget (initialized in joystick-init.js)
            var vis = {};
            vis.norm = null         // vega view object for normalized view (initialized in vis-normalized-init.js)
            vis.velo = null         // vega view object for velocity view (initialized in vis-velocity-init.js)

        </script>

        <script src="js/util.js" charset="utf-8"></script> <!-- defines util module -->
        <script src="js/vis-helper.js" charset="utf-8"></script> <!-- defines visHelper module -->
        <script src="js/joystick-init.js" charset="utf-8"></script> <!-- initializes joystick -->
        <script src="js/vis-normalized-init.js" charset="utf-8"></script>  <!-- initializes vis.norm -->
        <script src="js/vis-velocity-init.js" charset="utf-8"></script>  <!-- initializes vis.velo -->

        <!-- code related to event and input processing -->
        <script>
            var samplingRate  = 1000 / 30;
            var queueNextLoop = (function (callback) { window.setTimeout( callback,  samplingRate);});

            config.transferFunction = visVelocity.transferFunctions.identity;
            var hist = {                    // history
                normInput: {x: 0, y: 0},
                output: {x: 0, y: 0},
                timestamp: Date.now()
            };

            // main event loop
            function eventLoop() {
                // window.requestAnimFrame(eventLoop);
                queueNextLoop(eventLoop);

                // retrieve raw data from joystick
                if (joystickData === null ||
                    joystickData.distance < 12)     // papaya
                {
                    joystickData = {
                        angle: { degree: 0, radian: 0},
                        distance: 0,
                        position: {x: 0,y: 0}
                    }
                }

                // process input signal
                norm = normalizeInput(joystickData);

                // update normalized input signal vis
                if (config.normalizedView.showTrace)
                    visHelper.addPoint(vis.norm, norm.x, norm.y);
                else
                    visHelper.updatePoint(vis.norm, norm.x, norm.y);

                // apply transfer function
                var trans = {
                    x: config.transferFunction(norm.x),
                    y: config.transferFunction(norm.y)
                };

                // calculate ship position
                shipTarget = {
                    x: (trans.x + 1) * 600 / 2,
                    y: 350 - ((trans.y + 1) * 350 / 2),
                }

                // indirect absolute mapping
                // shipTarget = {
                //     x: (trans.x + 1) * 600 / 2,
                //     y: 350 - ((trans.y + 1) * 350 / 2),
                // }

                // move the ship
                game.ship.addEvent({"type": "move", data: shipTarget});

                // update velocity
                var dT = (Date.now() - hist.timestamp) / 1000;
                var velocity = {
                    input: util.pointDist(hist.normInput, norm)/dT,
                    output: util.pointDist(hist.output, game.ship)/dT
                };
                visVelocity.updateVelocity(velocity);


                // update text
                $("#normX").text(norm.x.toFixed(2));
                $("#normY").text(norm.y.toFixed(2));
                $("#vIn").text(velocity.input.toFixed(2));
                $("#vOut").text(velocity.output.toFixed(2));

                // record historical data
                hist.normInput = norm;
                hist.output = {x: game.ship.x, y: game.ship.y};
                hist.timestamp = Date.now();
            };

            function normalizeInput(data) {
                var normX = data.distance / 50 * Math.cos(data.angle.radian);
                var normY = data.distance / 50 * Math.sin(data.angle.radian);
                return {x: normX, y: normY};
            }


            // initialize UI
            (function () {
                $("#normTrace")
                    .prop("checked", config.normalizedView.showTrace)
                    .click(function() { config.normalizedView.showTrace = this.checked;} );

                $('#clearNormalizedView').click( function(){ visHelper.clearView(vis.norm); });
                $('#updateTransferFunction').click( function() {
                    var func = Function("x", "return " + $('#transferFunctionIn').val());

                    visVelocity.updateTransferFunction(func);
                })
            })();

            // fire the main event loop
            $(document).ready(eventLoop);

        </script>


    </body>
</html>
